<!doctype html>
<html class="no-js" lang="en" data-content_root="./">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="author" title="About these documents" href="about.html" /><link rel="index" title="Index" href="genindex.html" /><link rel="search" title="Search" href="search.html" /><link rel="next" title="About" href="about.html" /><link rel="prev" title="Basic usage" href="basic_usage.html" />

    <!-- Generated with Sphinx 7.4.7 and Furo 2023.09.10 -->
        <title>Advanced usage - linear-relational 0.6.2 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo.css?v=135e06be" />
    <link rel="stylesheet" type="text/css" href="_static/styles/furo-extensions.css?v=36a5483c" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="index.html"><div class="brand">linear-relational 0.6.2 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="index.html">
  
  
  <span class="sidebar-brand-text">linear-relational 0.6.2 documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="search.html" role="search">
  <input class="sidebar-search" placeholder="Search" name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="index.html">Home</a></li>
<li class="toctree-l1"><a class="reference internal" href="basic_usage.html">Basic usage</a></li>
<li class="toctree-l1 current current-page"><a class="current reference internal" href="#">Advanced usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html">About</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">API Reference:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api/trainer.html">Trainer</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/lre.html">Lre</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/concept.html">Concept</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/causal_editor.html">CausalEditor</a></li>
<li class="toctree-l1"><a class="reference internal" href="api/concept_matcher.html">ConceptMatcher</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Project Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/chanind/linear-relational">GitHub</a></li>
<li class="toctree-l1"><a class="reference external" href="https://pypi.org/project/linear-relational">PyPI</a></li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          
<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="advanced-usage">
<h1>Advanced usage<a class="headerlink" href="#advanced-usage" title="Link to this heading">¶</a></h1>
<section id="bulk-editing">
<h2>Bulk editing<a class="headerlink" href="#bulk-editing" title="Link to this heading">¶</a></h2>
<p>Edits can be performed in batches to make better use of GPU resources using <code class="docutils literal notranslate"><span class="pre">editor.swap_subject_concepts_and_predict_greedy_bulk()</span></code> as below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">linear_relational</span> <span class="kn">import</span> <span class="n">CausalEditor</span><span class="p">,</span> <span class="n">ConceptSwapAndPredictGreedyRequest</span>

<span class="n">concepts</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train_relation_concepts</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="n">editor</span> <span class="o">=</span> <span class="n">CausalEditor</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">concepts</span><span class="o">=</span><span class="n">concepts</span><span class="p">)</span>

<span class="n">swap_requests</span> <span class="o">=</span> <span class="p">[</span>
<span class="n">ConceptSwapAndPredictGreedyRequest</span><span class="p">(</span>
    <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Shanghai is located in the country of&quot;</span><span class="p">,</span>
    <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Shanghai&quot;</span><span class="p">,</span>
    <span class="n">remove_concept</span><span class="o">=</span><span class="s2">&quot;located in country: China&quot;</span><span class="p">,</span>
    <span class="n">add_concept</span><span class="o">=</span><span class="s2">&quot;located in country: France&quot;</span><span class="p">,</span>
    <span class="n">predict_num_tokens</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">),</span>
<span class="n">ConceptSwapAndPredictGreedyRequest</span><span class="p">(</span>
    <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Berlin is located in the country of&quot;</span><span class="p">,</span>
    <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Berlin&quot;</span><span class="p">,</span>
    <span class="n">remove_concept</span><span class="o">=</span><span class="s2">&quot;located in country: Germany&quot;</span><span class="p">,</span>
    <span class="n">add_concept</span><span class="o">=</span><span class="s2">&quot;located in country: Japan&quot;</span><span class="p">,</span>
    <span class="n">predict_num_tokens</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<span class="p">),</span>
<span class="p">]</span>
<span class="n">edited_answers</span> <span class="o">=</span> <span class="n">editor</span><span class="o">.</span><span class="n">swap_subject_concepts_and_predict_greedy_bulk</span><span class="p">(</span>
    <span class="n">requests</span><span class="o">=</span><span class="n">swap_requests</span><span class="p">,</span>
    <span class="n">edit_single_layer</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">magnitude_multiplier</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">edited_answers</span><span class="p">)</span> <span class="c1"># [&quot; France&quot;, &quot; Japan&quot;]</span>
</pre></div>
</div>
</section>
<section id="bulk-concept-matching">
<h2>Bulk concept matching<a class="headerlink" href="#bulk-concept-matching" title="Link to this heading">¶</a></h2>
<p>We can perform concept matches in batches to better utilize GPU resources using <code class="docutils literal notranslate"><span class="pre">matcher.query_bulk()</span></code> as below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">linear_relational</span> <span class="kn">import</span> <span class="n">ConceptMatcher</span><span class="p">,</span> <span class="n">ConceptMatchQuery</span>

<span class="n">concepts</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train_relation_concepts</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="n">matcher</span> <span class="o">=</span> <span class="n">ConceptMatcher</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">,</span> <span class="n">concepts</span><span class="o">=</span><span class="n">concepts</span><span class="p">)</span>

<span class="n">match_queries</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">ConceptMatchQuery</span><span class="p">(</span><span class="s2">&quot;Beijng is a northern city&quot;</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Beijing&quot;</span><span class="p">),</span>
    <span class="n">ConceptMatchQuery</span><span class="p">(</span><span class="s2">&quot;I sawi him in Marseille&quot;</span><span class="p">,</span> <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Marseille&quot;</span><span class="p">),</span>
<span class="p">]</span>
<span class="n">matches</span> <span class="o">=</span> <span class="n">matcher</span><span class="o">.</span><span class="n">query_bulk</span><span class="p">(</span><span class="n">match_queries</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">best_match</span><span class="o">.</span><span class="n">concept</span><span class="p">)</span> <span class="c1"># located in country: China</span>
<span class="nb">print</span><span class="p">(</span><span class="n">matches</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">best_match</span><span class="o">.</span><span class="n">concept</span><span class="p">)</span> <span class="c1"># located in country: France</span>
</pre></div>
</div>
</section>
<section id="customizing-lrc-training">
<h2>Customizing LRC training<a class="headerlink" href="#customizing-lrc-training" title="Link to this heading">¶</a></h2>
<p>The base <code class="docutils literal notranslate"><span class="pre">trainer.train_relation_concepts()</span></code> function is a convenience wrapper which trains a LRE,
performs a low-rank inverse of the LRE, and uses the inverted LRE to generate concepts. If you want to customize
this process, you can generate a LRE using <code class="docutils literal notranslate"><span class="pre">trainer.train_lre()</span></code>, followed by inverting the LRE with <code class="docutils literal notranslate"><span class="pre">lre.invert()</span></code>,
and finally training concepts from the inverted LRE with <code class="docutils literal notranslate"><span class="pre">trainer.train_relation_concepts_from_inv_lre()</span></code>. This process
is shown below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">linear_relational</span> <span class="kn">import</span> <span class="n">Trainer</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
<span class="n">prompts</span> <span class="o">=</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="n">lre</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train_lre</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">inv_lre</span> <span class="o">=</span> <span class="n">lre</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="n">concepts</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train_relation_concepts_from_inv_lre</span><span class="p">(</span>
    <span class="n">inv_lre</span><span class="o">=</span><span class="n">inv_lre</span><span class="p">,</span>
    <span class="n">prompts</span><span class="o">=</span><span class="n">prompts</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>It’s also possible to pass a lambda function as the <code class="docutils literal notranslate"><span class="pre">inv_lre</span></code> param to allow using a different inverted LRE
for each object. This lambda takes the object as a string and returns the inverted LRE for that object. However,
if you use this approach, you must also pass in <code class="docutils literal notranslate"><span class="pre">relation</span></code>, <code class="docutils literal notranslate"><span class="pre">object_aggregation</span></code> and <code class="docutils literal notranslate"><span class="pre">object_layer</span></code>, as these
cannot be inferred from the inverted LRE when passed as a function.</p>
<p>This is shown below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">linear_relational</span> <span class="kn">import</span> <span class="n">Trainer</span>

<span class="n">trainer</span> <span class="o">=</span> <span class="n">Trainer</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
<span class="n">prompts</span> <span class="o">=</span> <span class="p">[</span><span class="o">...</span><span class="p">]</span>

<span class="n">lre1</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train_lre</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">inv_lre1</span> <span class="o">=</span> <span class="n">lre</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="n">lre2</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train_lre</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="n">inv_lre2</span> <span class="o">=</span> <span class="n">lre</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">rank</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">inv_lre_fn</span><span class="p">(</span><span class="n">object_name</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">inv_lre1</span> <span class="k">if</span> <span class="n">object_name</span> <span class="o">==</span> <span class="s2">&quot;Paris&quot;</span> <span class="k">else</span> <span class="n">inv_lre2</span>

<span class="n">concepts</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train_relation_concepts_from_inv_lre</span><span class="p">(</span>
    <span class="n">inv_lre</span><span class="o">=</span><span class="n">inv_lre_fn</span><span class="p">,</span>
    <span class="n">prompts</span><span class="o">=</span><span class="n">prompts</span><span class="p">,</span>
    <span class="n">relation</span><span class="o">=</span><span class="s2">&quot;located_in_country&quot;</span><span class="p">,</span>
    <span class="n">object_aggregation</span><span class="o">=</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span>
    <span class="n">object_layer</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="custom-objects-in-prompts">
<h2>Custom objects in prompts<a class="headerlink" href="#custom-objects-in-prompts" title="Link to this heading">¶</a></h2>
<p>By default, when you create a <code class="docutils literal notranslate"><span class="pre">Prompt</span></code>, the answer to the prompt is assumed to be the object
corresponding to a LRC. For instance, in the prompt <code class="docutils literal notranslate"><span class="pre">Prompt(&quot;Paris</span> <span class="pre">is</span> <span class="pre">located</span> <span class="pre">in&quot;,</span> <span class="pre">&quot;France&quot;,</span> <span class="pre">subject=&quot;Paris&quot;)</span></code>,
the answer, “France”, is assumed to be the object. However, if this is not the case, you can specify the object
explicitly using the <code class="docutils literal notranslate"><span class="pre">object_name</span></code> parameter as below:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">linear_relational</span> <span class="kn">import</span> <span class="n">Prompt</span>

<span class="n">prompt1</span> <span class="o">=</span> <span class="n">Prompt</span><span class="p">(</span>
    <span class="n">text</span><span class="o">=</span><span class="s2">&quot;PARIS IS LOCATED IN&quot;</span><span class="p">,</span>
    <span class="n">answer</span><span class="o">=</span><span class="s2">&quot;FRANCE&quot;</span><span class="p">,</span>
    <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;PARIS&quot;</span><span class="p">,</span>
    <span class="n">object_name</span><span class="o">=</span><span class="s2">&quot;france&quot;</span><span class="p">,</span>
<span class="p">)</span>
<span class="n">prompt2</span> <span class="o">=</span> <span class="n">Prompt</span><span class="p">(</span>
    <span class="n">text</span><span class="o">=</span><span class="s2">&quot;Paris is located in&quot;</span><span class="p">,</span>
    <span class="n">answer</span><span class="o">=</span><span class="s2">&quot;France&quot;</span><span class="p">,</span>
    <span class="n">subject</span><span class="o">=</span><span class="s2">&quot;Paris&quot;</span><span class="p">,</span>
    <span class="n">object_name</span><span class="o">=</span><span class="s2">&quot;france&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
</section>
<section id="skipping-prompt-validation">
<h2>Skipping prompt validation<a class="headerlink" href="#skipping-prompt-validation" title="Link to this heading">¶</a></h2>
<p>By default, the <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> will validate that for every prompt passed in, that the model answers the prompt correctly,
and will filter out any prompts where this is not the case.
If you want to skip this validation, you can pass <code class="docutils literal notranslate"><span class="pre">validate_prompts=False</span></code> to all methods on the trainer
like <code class="docutils literal notranslate"><span class="pre">Trainer.train_relation_concepts(prompts,</span> <span class="pre">validate_prompts=False)</span></code>.</p>
</section>
<section id="multi-token-object-aggregation">
<h2>Multi-token object aggregation<a class="headerlink" href="#multi-token-object-aggregation" title="Link to this heading">¶</a></h2>
<p>If a prompt has an answer which is multiple tokens, by default the <code class="docutils literal notranslate"><span class="pre">Trainer</span></code> will use the mean activation of
the tokens in the answer when training a LRE. An example of a prompt with a multi-token answer is “The CEO of Microsoft is Bill Gates”,
where the object, “Bill Gates”, has two tokens. Alternatively, you can use just the first token of the object by
passing <code class="docutils literal notranslate"><span class="pre">object_aggregation=&quot;first_token&quot;</span></code> when training a LRE. For instance, you can run the following:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">lre</span> <span class="o">=</span> <span class="n">trainer</span><span class="o">.</span><span class="n">train_lre</span><span class="p">(</span>
    <span class="n">prompts</span><span class="o">=</span><span class="n">prompts</span><span class="p">,</span>
    <span class="n">object_aggregation</span><span class="o">=</span><span class="s2">&quot;first_token&quot;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>If the answer is a single token, “mean” and “first_token” are equivalent.</p>
</section>
<section id="custom-layer-selection">
<h2>Custom layer selection<a class="headerlink" href="#custom-layer-selection" title="Link to this heading">¶</a></h2>
<p>By default, the library will try to guess which layers corresponding to hidden activations in the model,
and will use these layers for reading activations and training LREs. If the layers the library guesses are not
correct, or if you want to use different layers to extract activations and train LREs, you can pass in a
custom <code class="docutils literal notranslate"><span class="pre">layer_matcher</span></code> to the <code class="docutils literal notranslate"><span class="pre">Trainer</span></code>, <code class="docutils literal notranslate"><span class="pre">CausalEditor</span></code>, and <code class="docutils literal notranslate"><span class="pre">ConceptMatcher</span></code> when creating these
objects.</p>
<p>A <code class="docutils literal notranslate"><span class="pre">layer_matcher</span></code> is typically A string, and must include the substring <code class="docutils literal notranslate"><span class="pre">&quot;{num}&quot;</span></code> which will be replaced
with the layer number to select a layer in the model. For instance, for GPT models, the matcher for
hidden layers is <code class="docutils literal notranslate"><span class="pre">&quot;transformer.h.{num}&quot;</span></code>. You can find a list of all layers in a model by calling
<code class="docutils literal notranslate"><span class="pre">model.named_modules()</span></code>.</p>
<p>For most cases, using a string is sufficient, but if you want to customize the layer matcher further
you can pass in a function to <code class="docutils literal notranslate"><span class="pre">layer_matcher</span></code> which takes in the layer number as an int and
returns the layer in the model as a string. For instance, for GPT models, this could be provided as
<code class="docutils literal notranslate"><span class="pre">lambda</span> <span class="pre">num:</span> <span class="pre">f&quot;transformer.h.{num}&quot;</span></code>.</p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="about.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">About</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="basic_usage.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">Basic usage</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                Copyright &#169; 2024, David Chanin
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">Advanced usage</a><ul>
<li><a class="reference internal" href="#bulk-editing">Bulk editing</a></li>
<li><a class="reference internal" href="#bulk-concept-matching">Bulk concept matching</a></li>
<li><a class="reference internal" href="#customizing-lrc-training">Customizing LRC training</a></li>
<li><a class="reference internal" href="#custom-objects-in-prompts">Custom objects in prompts</a></li>
<li><a class="reference internal" href="#skipping-prompt-validation">Skipping prompt validation</a></li>
<li><a class="reference internal" href="#multi-token-object-aggregation">Multi-token object aggregation</a></li>
<li><a class="reference internal" href="#custom-layer-selection">Custom layer selection</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="_static/documentation_options.js?v=1c28bd9a"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/scripts/furo.js?v=32e29ea5"></script>
    </body>
</html>